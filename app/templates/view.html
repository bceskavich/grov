{% extends "base.html" %}

{% block content %}
<div class="viewbox parent">
</div>
<div class="buttons">
    <button class="zoom-in">Zoom In</button>
    <button class="zoom-out">Zoom Out</button>
    <input type="range" class="zoom-range">
    <button class="reset">Reset</button>
</div>
<script>
    var scale = .75,
        width = $('.viewbox').width(),
        height = $('.viewbox').height();

    var force = d3.layout.force()
        .charge(-150)
        .linkDistance(75)
        .size([width, height]);

    var svg = d3.select('.viewbox').append('svg')
        .attr('class', 'panzoom')
        .attr('width', width)
        .attr('height', height);

    d3.json('{{datasource}}', function(e, graph){
        var n = graph.nodes.length;

        force.nodes(graph.nodes)
            .links(graph.links);

        graph.nodes.forEach(function(d, i) {
            d.x = d.y = width / n * i;
        });

        force.start();
        for (var i = n; i > 0; --i) force.tick();
        force.stop();

        // Centering
        var ox = 0,
            oy = 0;

        graph.nodes.forEach(function(d) {
            ox += d.x,
            oy += d.y;
        });

        ox = ox / n - width / 2;
        oy = oy / n - height / 2;

        graph.nodes.forEach(function(d) {
            d.x -= ox,
            d.y -= oy;
        });

        var link = svg.selectAll('.link')
            .data(graph.links)
            .enter().append('line')
            .attr('class','link')
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        var node = svg.selectAll('.node')
            .data(graph.nodes)
            .enter().append('circle')
            .attr('class', function(d){
                return 'node ' + d.class;
            })
            .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; })
            .attr('r', function(d){
                return scale * (d.amnt * 4);
            });

        node.append('title')
            .text(function(d){
                return d.label;
            });

    });

    $(document).ready(function(){
        $('.panzoom').panzoom({
            $zoomIn: $(".zoom-in"),
            $zoomOut: $(".zoom-out"),
            $zoomRange: $(".zoom-range"),
            $reset: $(".reset")
        });
    });
</script>
{% endblock %}
